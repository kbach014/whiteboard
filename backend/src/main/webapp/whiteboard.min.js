/*! Whiteboard 0.1.0 12-06-2015 */
angular.module("whiteboard",["ngRoute"]),angular.module("whiteboard").config(["$routeProvider","$httpProvider",function(a){"use strict";a.when("/login",{controller:"LoginCtrl",templateUrl:"partials/login.html"}),a.when("/registration",{controller:"RegistrationCtrl",templateUrl:"partials/registration.html"}),a.when("/whiteboard/:id",{controller:"WhiteboardCtrl",templateUrl:"partials/whiteboard.html"}),a.otherwise({redirectTo:"/whiteboard/2"})}]),angular.module("whiteboard").run(["$location","$rootScope","userService",function(a,b,c){b.currentPath=function(){return a.path()},c.registerLoginLogoutObserver(function(){b.currentUser=c.getCurrentUser()}),b.currentUser=c.getCurrentUser()}]),angular.module("whiteboard").controller("LoginCtrl",["$scope","userService",function(a,b){"use strict";a.login=function(c,d){b.login(c,d).then(function(){a.successMessage="Login erfolgreich."},function(){a.errorMessage="Login fehlgeschlagen."})},a.logout=function(){b.logout()},a.dismissErrorMessage=function(){a.errorMessage=null},a.dismissSuccessMessage=function(){a.successMessage=null}}]),angular.module("whiteboard").controller("RegistrationCtrl",["$scope","userService",function(a,b){"use strict";a.register=function(c,d,e,f,g){c&&d&&e&&f&&g?f!=g?a.errorMessage="Passwörter stimmen nicht überein.":b.register({firstname:c,lastname:d,username:e,password:f}).then(function(){a.successMessage="Registrierung erfolgreich."},function(){a.errorMessage="Fehler bei der Registrierung."}):a.errorMessage="Bitte alle Felder ausfüllen."},a.dismissErrorMessage=function(){a.errorMessage=null},a.dismissSuccessMessage=function(){a.successMessage=null}}]),angular.module("whiteboard").controller("WhiteboardCtrl",["$scope","$routeParams","whiteboardService",function(a,b,c){"use strict";b.id&&c.connect(b.id).then(function(){a.successMessage="Connection established."},function(){a.errorMessage="Unable to connect to shared whiteboard."}),a.shapes=[],a.shapetype="PATH",a.updateShape=function(b){c.scheduleDrawEvent(b);var d=_.findWhere(a.shapes,{uuid:b.shape.uuid});d?_.assign(d,b.shape):a.shapes.push(b.shape)},a.dismissErrorMessage=function(){a.errorMessage=null},a.dismissSuccessMessage=function(){a.successMessage=null}}]),angular.module("whiteboard").directive("whiteboardShapes",["$interval","uuidService",function(a,b){"use strict";return{restrict:"A",scope:{callback:"&whiteboardEventCallback",eventFps:"=whiteboardEventFps",renderFps:"=whiteboardRenderFps",shapes:"=whiteboardShapes",shapeType:"=whiteboardShapeType"},link:function(c,d){var e=null,f=d[0],g=f.getContext("2d"),h=function(a){if(a&&a.type)switch(g.fillStyle=a.color||"black",g.strokeStyle=a.color||"black",a.type){case"PATH":if(a.points&&a.points.length>1){var b=_.first(a.points),c=_.rest(a.points);g.beginPath(),g.moveTo(b.x,b.y),_.forEach(c,function(a){g.lineTo(a.x,a.y)}),g.stroke()}return;case"RECT":return void(a.p1&&a.p2&&!_.isEqual(a.p1,a.p2)&&g.fillRect(Math.min(a.p1.x,a.p2.x),Math.min(a.p1.y,a.p2.y),Math.abs(a.p1.x-a.p2.x),Math.abs(a.p1.y-a.p2.y)));case"TEXT":return;default:console.warn("Unsupported shape ",a.shape)}},i=function(){g.clearRect(0,0,f.width,f.height);var a=_.uniq(c.shapes,!1,"uuid");_.forEach(a,function(a){h(a)}),h(e)},j=function(){null!==e&&c.callback({event:{type:"UPDATE",shape:e}})};d.on("mousedown",function(a){switch(c.shapeType){case"PATH":e={uuid:b.generateUUID(),type:"PATH",finished:!1,points:[{x:a.offsetX,y:a.offsetY}]};break;case"RECT":e={uuid:b.generateUUID(),type:"RECT",finished:!1,p1:{x:a.offsetX,y:a.offsetY},p2:{x:a.offsetX,y:a.offsetY}};break;case"TEXT":e={uuid:b.generateUUID(),type:"TEXT",finished:!1,p1:{x:a.offsetX,y:a.offsetY}};break;default:console.warn("Unsupported shape ",c.shapeType)}}),d.on("mousemove",function(a){if(null!==e)switch(e.type){case"PATH":e.points.push({x:a.offsetX,y:a.offsetY});break;case"RECT":e.p2={x:a.offsetX,y:a.offsetY}}}),d.on("mouseup",function(a){if(null!==e){switch(e.finished=!0,e.type){case"PATH":e.points.push({x:a.offsetX,y:a.offsetY});break;case"RECT":e.p2={x:a.offsetX,y:a.offsetY}}c.callback({event:{type:"FINISH",shape:e}}),e=null}}),d.on("mouseout",function(){if(null!==e){switch(e.type){case"PATH":e.points=[];break;case"RECT":e.p2=e.p1;break;case"TEXT":e.text=""}c.callback({event:{type:"CANCEL",shape:e}}),e=null}});var k=a(i,1e3/(c.renderFps||1)),l=a(j,1e3/(c.eventFps||1));d.on("$destroy",function(){a.cancel(k),a.cancel(l)})}}}]),angular.module("whiteboard").factory("userService",["$http","$q",function(a,b){"use strict";var c=[],d=function(){_.forEach(c,function(a){a()})},e=null;return{registerLoginLogoutObserver:function(a){c.push(a)},unregisterLoginLogoutObserver:function(a){_.remove(c,a)},getCurrentUser:function(){return e},login:function(c,f){var g=b.defer();return a.post("/backend/rest/users/login",{username:c,password:f}).success(function(a){e=a,d(),g.resolve()}).error(function(){e=null,d(),g.reject()}),g.promise},logout:function(){e=null,d(),a.post("/backend/rest/users/logout")},register:function(c){var d=b.defer();return a.post("/backend/rest/users/register",c).success(function(){d.resolve()}).error(function(){d.reject()}),d.promise}}}]),angular.module("whiteboard").factory("uuidService",[function(){"use strict";return{generateUUID:function(){function a(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return(a()+a()+"-"+a()+"-4"+a().substr(0,3)+"-"+a()+"-"+a()+a()+a()).toLowerCase()}}}]),angular.module("whiteboard").factory("whiteboardService",["$http","$q","$interval",function(a,b,c){"use strict";var d,e=[],f=null,g=function(){if(d&&d.readyState===WebSocket.OPEN&&!_.isEmpty(e)){var a=e;e=[],console.log("SEND",a),d.send(JSON.stringify(a))}};return{connect:function(a){this.close();var e=b.defer();return d=new WebSocket("ws://localhost:8080/backend/drawings/"+a),d.onerror=function(){e.reject()},d.onmessage=function(a){console.log("RECEIVE",JSON.parse(a.data))},d.onopen=function(){d.onerror=_.noop(),f=c(g,100,!1),e.resolve()},e.promise},setErrorCallback:function(a){d.onerror=_.isFunction(a)?a:_.noop()},scheduleDrawEvent:function(a){e.push(a)},close:function(){f&&(c.cancel(f),f=null),d&&d.readyState===WebSocket.OPEN&&d.close()}}}]);